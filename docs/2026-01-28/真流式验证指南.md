# çœŸæµå¼ Image-to-Excalidraw éªŒè¯æŒ‡å—

## ğŸ“‹ å®ç°æ€»ç»“

### é—®é¢˜
åŸæ¥çš„å›¾ç‰‡ä¸Šä¼ æ˜¯"å‡æµå¼"ï¼šAI å…ˆç”Ÿæˆå®Œæ•´ JSON â†’ ç„¶åäººä¸ºé€ä¸ªæ˜¾ç¤ºå…ƒç´ ï¼ˆ0.3s å»¶è¿Ÿï¼‰

### è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨ **Multimodal Streaming API** å®ç°çœŸæµå¼ï¼šè¾¹ç”Ÿæˆ JSON token â†’ è¾¹å¢é‡è§£æ â†’ è¾¹æ˜¾ç¤ºå…ƒç´ 

## ğŸ”‘ æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

### 1. API ç±»å‹å·®å¼‚

| API ç±»å‹ | æ˜¯å¦æµå¼ | ç”¨æ³• |
|---------|---------|------|
| Vision API | âŒ ä¸æ”¯æŒ | `generate_with_vision(image, prompt)` |
| Multimodal Text API | âœ… æ”¯æŒ | `messages.stream(content=[image, text])` |

### 2. å…³é”®ä»£ç æ”¹åŠ¨

#### `backend/app/services/ai_vision.py`
æ·»åŠ äº† `generate_with_vision_stream()` æ–¹æ³• (lines 1401-1499)ï¼š

```python
async def generate_with_vision_stream(self, image_data: bytes, prompt: str):
    """çœŸæµå¼ Vision ç”Ÿæˆï¼šæ”¯æŒå›¾ç‰‡+æ–‡æœ¬çš„æµå¼è¾“å‡º"""

    # Claude ç¤ºä¾‹
    content = [
        {
            "type": "image",
            "source": {
                "type": "base64",
                "media_type": "image/png",
                "data": base64_image
            }
        },
        {
            "type": "text",
            "text": prompt
        }
    ]

    with self.client.messages.stream(
        model=self.model_name,
        messages=[{"role": "user", "content": content}],
        stream=True
    ) as stream:
        for text in stream.text_stream:
            yield text  # ğŸ”¥ å®æ—¶ yield token
```

#### `backend/app/api/vision.py`
é‡å†™ç«¯ç‚¹ (lines 538-743)ï¼Œæ ¸å¿ƒé€»è¾‘ï¼š

```python
# ğŸ”¥ çœŸæµå¼è°ƒç”¨
json_buffer = ""
parsed_ids = set()

async for token in vision_service.generate_with_vision_stream(image_bytes, prompt):
    json_buffer += token  # ç´¯ç§¯ token

    # ğŸ”¥ å¢é‡è§£æï¼šæå–å·²å®Œæˆçš„å…ƒç´ 
    new_elements = try_parse_incremental_elements(json_buffer, parsed_ids)

    # ğŸ”¥ ç«‹å³ yield
    for element in new_elements:
        normalized = normalize_element(element, timestamp)
        yield f"data: {json.dumps({'type': 'element', 'element': normalized})}\n\n"
```

#### å¢é‡è§£æç®—æ³• (`try_parse_incremental_elements`)

```python
def try_parse_incremental_elements(json_buffer: str, parsed_ids: set) -> list:
    """
    ä»ä¸å®Œæ•´çš„ JSON ä¸­æå–å·²å®Œæˆçš„å…ƒç´ å¯¹è±¡
    ä½¿ç”¨æ‹¬å·å¹³è¡¡ç®—æ³•æ‰¾åˆ°å®Œæ•´çš„ {...}
    """
    # 1. æ­£åˆ™æå– elements æ•°ç»„
    elements_pattern = r'"elements"\s*:\s*\[\s*(.*?)(?:\]|$)'
    match = re.search(elements_pattern, json_buffer, re.DOTALL)

    # 2. éå†å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°å¹³è¡¡çš„ {...}
    brace_count = 0
    for i, char in enumerate(elements_str):
        if char == '{':
            if brace_count == 0:
                start_idx = i
            brace_count += 1
        elif char == '}':
            brace_count -= 1
            if brace_count == 0:
                # ğŸ”¥ æ‰¾åˆ°å®Œæ•´å…ƒç´ 
                element_str = elements_str[start_idx:i+1]
                element = json.loads(element_str)
                if element.get("id") not in parsed_ids:
                    yield element
```

### 3. AI é…ç½®

**é¢„è®¾é…ç½®** (`frontend/lib/store/useArchitectStore.ts`):
```typescript
modelConfig: {
  provider: "custom",
  apiKey: "sk-7Vm4JJgG9J7ghGWdtxH4vOqyVgpMcPs9zgeBLj9RqHhCswlh",
  modelName: "claude-sonnet-4-5-20250929",
  baseUrl: "https://www.linkflow.run/v1",
}
```

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡

```bash
# ç»ˆç«¯ 1: å¯åŠ¨åç«¯
cd backend
venv\Scripts\activate
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# ç»ˆç«¯ 2: å¯åŠ¨å‰ç«¯
cd frontend
npm run dev
```

### 2. æµ‹è¯•çœŸæµå¼

1. è®¿é—® http://localhost:3000
2. åˆ‡æ¢åˆ° **Excalidraw æ¨¡å¼**
3. ç‚¹å‡»å³ä¾§èŠå¤©æ¡†çš„**å›¾ç‰‡ä¸Šä¼ æŒ‰é’®**
4. ä¸Šä¼ ä¸€å¼ æ¶æ„å›¾/æµç¨‹å›¾
5. è§‚å¯Ÿ Excalidraw ç”»æ¿

### 3. åˆ¤æ–­æ ‡å‡†

#### âœ… çœŸæµå¼ï¼ˆæˆåŠŸï¼‰
- ä¸Šä¼ åç«‹å³å¼€å§‹æ˜¾ç¤ºå…ƒç´ 
- å…ƒç´ **é€ä¸ªå‡ºç°**ï¼Œé—´éš”ä¸è§„å¾‹ï¼ˆå–å†³äº AI ç”Ÿæˆé€Ÿåº¦ï¼‰
- æ§åˆ¶å°æ—¥å¿—ï¼š`[REAL STREAM] Yielded element 1: <id>`
- åç«¯æ—¥å¿—ï¼š`[VISION-STREAM] Claude streaming with model: claude-sonnet-4-5-20250929`

#### âŒ å‡æµå¼ï¼ˆå¤±è´¥ï¼‰
- ä¸Šä¼ åç­‰å¾…å¾ˆä¹…ï¼ˆ10-30ç§’ï¼‰æ‰å¼€å§‹æ˜¾ç¤º
- çœ‹åˆ° "Parsing AI response..." æ¶ˆæ¯
- å…ƒç´ é—´éš”å›ºå®šï¼ˆ0.3ç§’ï¼‰
- æ—¥å¿—æ—  `[REAL STREAM]` æ ‡è®°

### 4. æ£€æŸ¥æ—¥å¿—

**åç«¯æ—¥å¿—** (`backend/logs/smartarchitect.log`):
```
[VISION-STREAM] Claude streaming with model: claude-sonnet-4-5-20250929
[REAL STREAM] Yielded element 1: rect-1
[REAL STREAM] Yielded element 2: arrow-1
[REAL STREAM] Yielded element 3: text-1
[REAL STREAM] Completed with 10 elements in real-time
```

**å‰ç«¯æ§åˆ¶å°**:
```
[SSE] Received event: element id=rect-1
[Excalidraw Upload] Streaming element 1/0: rect-1
[SSE] Received event: element id=arrow-1
[Excalidraw Upload] Streaming element 2/0: arrow-1
```

## ğŸ”§ é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ä»ç„¶æ˜¯å‡æµå¼

**å¯èƒ½åŸå› **: linkflow.run ä¸æ”¯æŒ multimodal streaming

**è§£å†³æ–¹æ¡ˆ**: æš‚æ—¶ä½¿ç”¨å®˜æ–¹ Claude API
```typescript
modelConfig: {
  provider: "claude",
  apiKey: "sk-ant-xxx",  // å®˜æ–¹ Anthropic API key
  modelName: "claude-sonnet-4-5-20250929",
  baseUrl: "",  // ç•™ç©ºä½¿ç”¨å®˜æ–¹ API
}
```

### é—®é¢˜ 2: ç«¯å£å ç”¨

```bash
# Windows
netstat -ano | findstr :8000
taskkill /F /PID <PID>

# Linux/Mac
lsof -ti:8000 | xargs kill -9
```

### é—®é¢˜ 3: å¢é‡è§£æå¤±è´¥

**ç°è±¡**: åç«¯æ—¥å¿—æ˜¾ç¤ºæµå¼ï¼Œä½†å‰ç«¯æ— å…ƒç´ 

**æ£€æŸ¥**:
- åç«¯æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `[REAL STREAM] Yielded element`
- å‰ç«¯æ§åˆ¶å°æ˜¯å¦æœ‰ SSE é”™è¯¯
- æ£€æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| `VISION_STREAMING_IMPLEMENTATION.md` | æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£ |
| `REAL_STREAMING_IMPLEMENTATION_COMPLETE.md` | è¯¦ç»†å®ç°æŠ¥å‘Š |
| `çœŸæµå¼éªŒè¯æŒ‡å—.md` | æœ¬æ–‡æ¡£ |

## ğŸ¯ éªŒè¯æ£€æŸ¥æ¸…å•

- [ ] åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼ˆhttp://localhost:8000/api/health è¿”å› healthyï¼‰
- [ ] å‰ç«¯æœåŠ¡è¿è¡Œæ­£å¸¸ï¼ˆhttp://localhost:3000 å¯è®¿é—®ï¼‰
- [ ] AI é…ç½®æ­£ç¡®ï¼ˆProvider: custom, Model: claude-sonnet-4-5-20250929ï¼‰
- [ ] ä¸Šä¼ å›¾ç‰‡åç«‹å³å¼€å§‹ç”Ÿæˆï¼ˆæ— é•¿æ—¶é—´ç­‰å¾…ï¼‰
- [ ] å…ƒç´ é€ä¸ªå‡ºç°ï¼ˆé—´éš”ä¸è§„å¾‹ï¼‰
- [ ] åç«¯æ—¥å¿—æœ‰ `[REAL STREAM]` æ ‡è®°
- [ ] å‰ç«¯æ§åˆ¶å°æ—  SSE é”™è¯¯

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **çœŸæµå¼æ¶æ„**: ä½¿ç”¨ multimodal streaming APIï¼Œä¸æ˜¯çº¯ Vision API
2. **å¢é‡è§£æ**: æ‹¬å·å¹³è¡¡ç®—æ³•å®æ—¶æå–å®Œæ•´ JSON å¯¹è±¡
3. **å»é‡æœºåˆ¶**: ä½¿ç”¨ `parsed_ids` set é¿å…é‡å¤å‘é€
4. **å‰ç«¯å…¼å®¹**: æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ï¼Œå®Œå…¨å‘åå…¼å®¹
5. **æ€§èƒ½ä¼˜åŒ–**: ç§»é™¤äººä¸ºå»¶è¿Ÿï¼Œå…ƒç´ å‡ºç°é€Ÿåº¦å–å†³äº AI

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **linkflow.run æ”¯æŒå¾…éªŒè¯**: é¦–æ¬¡æµ‹è¯•å¯èƒ½éœ€è¦åˆ‡æ¢åˆ°å®˜æ–¹ API
2. **Gemini ä¸æ”¯æŒ**: Gemini çš„ vision API ä¸æ”¯æŒ multimodal streaming
3. **ç½‘ç»œç¨³å®šæ€§**: æµå¼ä¼ è¾“å¯¹ç½‘ç»œè¦æ±‚è¾ƒé«˜ï¼Œä¸ç¨³å®šæ—¶å¯èƒ½ä¸­æ–­
4. **Token é™åˆ¶**: Claude çš„ max_tokens è®¾ç½®ä¸º 16384ï¼Œè¶³å¤Ÿç”Ÿæˆå¤æ‚å›¾è¡¨

---

**å®æ–½æ—¥æœŸ**: 2026-01-28
**å®æ–½è€…**: Claude Sonnet 4.5
**ä¸‹æ¬¡éªŒè¯**: å¾…å®š
