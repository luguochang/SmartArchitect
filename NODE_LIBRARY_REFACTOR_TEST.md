# 节点库重构自测报告

## 重构概览

**时间**: 2026-01-31
**重构内容**: 三步走方案重构节点库，解决图标和画布不一致问题
**涉及文件**:
- ✅ 新建: `frontend/components/nodes/ShapeRenderer.tsx` (统一渲染组件)
- ✅ 重构: `frontend/components/Sidebar.tsx` (节点库UI和数据结构)
- ✅ 增强: `frontend/components/ArchitectCanvas.tsx` (拖拽体验和快捷键)

---

## 测试清单

### 1. ShapeRenderer 组件测试

**目标**: 确保所有节点形状在预览和画布上渲染一致

#### 1.1 基础图形 (12个)
- [ ] 矩形 (rectangle) - 蓝色
- [ ] 圆角矩形 (rounded-rectangle) - 浅蓝色
- [ ] 圆形 (circle) - 绿色
- [ ] 菱形 (diamond) - 黄色
- [ ] 六边形 (hexagon) - 紫色
- [ ] 三角形 (triangle) - 橙色
- [ ] 平行四边形 (parallelogram) - 青色
- [ ] 梯形 (trapezoid) - 靛蓝色
- [ ] 星形 (star) - 黄色
- [ ] 云形 (cloud) - 天蓝色
- [ ] 圆柱 (cylinder) - 青绿色
- [ ] 文档 (document) - 灰色

#### 1.2 流程图 (10个)
- [ ] 开始 (start) - 绿色圆形
- [ ] 结束 (end) - 红色粗边圆形
- [ ] 过程 (process) - 蓝色矩形
- [ ] 判断 (decision) - 黄色菱形
- [ ] 数据 (data) - 青色平行四边形
- [ ] 子流程 (subprocess) - 紫色圆角矩形
- [ ] 延迟 (delay) - 橙色半圆矩形
- [ ] 合并 (merge) - 靛蓝色圆形
- [ ] 手动输入 (manual-input) - 灰色斜边矩形
- [ ] 准备 (preparation) - 青绿色六边形

#### 1.3 BPMN (6个)
- [ ] 开始事件 (bpmn-start-event) - 绿色细边圆
- [ ] 结束事件 (bpmn-end-event) - 红色粗边圆
- [ ] 中间事件 (bpmn-intermediate-event) - 黄色双边圆
- [ ] 任务 (bpmn-task) - 蓝色圆角矩形+装饰条
- [ ] 网关 (bpmn-gateway) - 橙色菱形
- [ ] 子流程 (bpmn-subprocess) - 紫色圆角矩形

#### 1.4 架构组件 (9个)
- [ ] API - 蓝色圆角矩形
- [ ] 服务 (service) - 紫色圆角矩形
- [ ] 数据库 (database) - 绿色圆柱
- [ ] 缓存 (cache) - 黄色圆角矩形
- [ ] 队列 (queue) - 靛蓝色圆角矩形
- [ ] 存储 (storage) - 灰色圆柱
- [ ] 网关 (gateway) - 橙色圆角矩形
- [ ] 客户端 (client) - 青色圆角矩形
- [ ] Layer Frame - 翠绿色框架

**测试方法**:
```bash
# 启动开发服务器
cd frontend
npm run dev
```

访问 http://localhost:3000，检查左侧节点库:
1. 所有节点预览都应该显示正确的形状和颜色
2. 预览图标应该和实际节点形状完全一致
3. 无 console 错误

---

### 2. Sidebar 节点库测试

#### 2.1 UI 交互测试
- [ ] **搜索功能**: 输入"矩形"应只显示矩形相关节点
- [ ] **分类展开/折叠**: 点击分类标题可切换展开状态
- [ ] **默认展开**: "基础图形"、"流程图"、"架构组件"默认展开
- [ ] **节点计数**: 每个分类显示正确的节点数量
- [ ] **悬停效果**: 鼠标悬停节点卡片时有高亮边框和阴影
- [ ] **深色模式**: 切换深色模式后UI正常显示

#### 2.2 节点添加测试
- [ ] **点击添加**: 点击节点卡片，节点出现在画布随机位置
- [ ] **拖拽添加**: 拖拽节点卡片到画布指定位置
- [ ] **添加反馈**: 添加节点后显示 toast 提示

#### 2.3 数据一致性测试
- [ ] 左侧预览的矩形 → 画布上也是矩形（相同颜色）
- [ ] 左侧预览的菱形 → 画布上也是菱形（相同颜色）
- [ ] 左侧预览的BPMN开始事件 → 画布上是细边圆（相同样式）
- [ ] 左侧预览的BPMN任务 → 画布上有左侧装饰条（相同样式）

**测试方法**:
1. 展开每个分类，检查节点预览
2. 每个分类随机选3个节点添加到画布
3. 对比预览图和画布上的实际节点是否一致

---

### 3. 拖拽体验增强测试

#### 3.1 网格对齐 (Snap to Grid)
- [ ] **默认对齐**: 拖拽节点放置时自动对齐到20px网格
- [ ] **禁用对齐**: 按住 Shift 键拖拽时不对齐网格
- [ ] **视觉验证**: 节点位置坐标是20的倍数（如 x: 100, y: 140）

测试步骤:
```
1. 拖拽一个节点到画布
2. 查看节点 position (右键检查或开发者工具)
3. position.x 和 position.y 应该是 20 的倍数
4. 按住 Shift 再拖拽，position 可以是任意值
```

#### 3.2 拖拽预览 (Ghost Image)
- [ ] **拖拽时显示提示**: 显示"拖拽添加 [节点名称]"
- [ ] **自定义样式**: Ghost image 有白色背景、圆角、阴影
- [ ] **跟随鼠标**: Ghost image 跟随鼠标移动

---

### 4. 快捷键测试

#### 4.1 快捷键功能
- [ ] **Cmd/Ctrl + L**: 自动布局 + toast 提示"已应用自动布局"
- [ ] **Cmd/Ctrl + F**: Fit View + toast 提示"已适配视图"
- [ ] **Cmd/Ctrl + Shift + C**: 清空画布（需确认）
- [ ] **Delete / Backspace**: 删除选中的节点和边

#### 4.2 快捷键冲突测试
- [ ] Cmd/Ctrl + A: 不与其他功能冲突（浏览器全选可能被拦截）
- [ ] Cmd/Ctrl + F: 不触发浏览器搜索
- [ ] 快捷键在输入框聚焦时不生效

测试步骤:
```
1. 添加5个节点到画布
2. 按 Cmd/Ctrl + L，检查节点自动排列
3. 按 Cmd/Ctrl + F，检查画布自动适配
4. 按 Cmd/Ctrl + Shift + C，确认后画布清空
```

---

### 5. 性能测试

#### 5.1 节点库性能
- [ ] 节点库初次加载时间 < 500ms
- [ ] 搜索响应时间 < 100ms
- [ ] 滚动节点列表流畅（无卡顿）

#### 5.2 渲染性能
- [ ] 添加50个节点后，拖拽仍然流畅
- [ ] ShapeRenderer 预览组件不影响页面性能
- [ ] React DevTools Profiler: Sidebar 渲染时间 < 16ms

---

### 6. 兼容性测试

#### 6.1 浏览器兼容
- [ ] Chrome/Edge (Chromium)
- [ ] Firefox
- [ ] Safari (macOS)

#### 6.2 操作系统兼容
- [ ] Windows (Cmd → Ctrl)
- [ ] macOS (Cmd)
- [ ] Linux (Ctrl)

---

## 已知问题和限制

1. **Ghost Image 兼容性**: Safari 可能不支持 `setDragImage()`
2. **网格对齐**: 仅在拖拽放置时生效，移动已有节点不自动对齐
3. **快捷键**: 某些浏览器扩展可能拦截快捷键

---

## 测试结果总结

### 通过率
- [ ] 所有基础图形渲染一致
- [ ] 所有流程图节点渲染一致
- [ ] 所有BPMN节点渲染一致
- [ ] 所有架构组件渲染一致
- [ ] 拖拽体验流畅
- [ ] 快捷键正常工作
- [ ] 无明显性能问题

### 发现的问题
_(测试时填写)_

1.
2.
3.

---

## 快速自测命令

```bash
# 1. 启动前端
cd frontend
npm run dev

# 2. 检查编译错误（另一个终端）
npm run build

# 3. 检查代码规范
npm run lint

# 4. 手动测试步骤
# - 访问 http://localhost:3000
# - 切换到 React Flow 画布
# - 展开左侧所有节点分类
# - 随机添加10个不同节点到画布
# - 检查预览和实际节点是否一致
# - 测试拖拽对齐（Shift键切换）
# - 测试所有快捷键
```

---

## 参考设计

- **设计灵感**: Draw.io 节点库布局
- **React Flow**: v11+ 拖拽API
- **Lucide Icons**: 图标库
- **Tailwind CSS**: 样式系统

---

## 下一步优化建议

1. **节点分组**: 允许用户自定义节点收藏夹
2. **最近使用**: 显示最近添加的节点
3. **节点模板**: 保存节点+样式组合
4. **键盘导航**: 支持 Tab/Arrow 键浏览节点库
5. **批量添加**: Ctrl+点击多选节点，一次性添加

---

**测试人员**: Claude Code
**测试日期**: 2026-01-31
**版本**: v0.5.1-node-library-refactor
